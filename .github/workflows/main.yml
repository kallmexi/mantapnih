name: XY_RDP_1080P_FINAL

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */8 * * *'

jobs:
  XY_PROJECT:
    runs-on: windows-latest
    timeout-minutes: 10080

    steps:
      # STEP 1: Download script dari repo ini
      - name: ğŸ“¥ DOWNLOAD - Get PowerShell Scripts
        run: |
          # Ini cuma placeholder, script aslinya bakal ditulis langsung di bawah
          Write-Host "Mempersiapkan environment..." -ForegroundColor Cyan

      - name: âœ… VALIDASI SECRETS
        run: |
          $errors = @()
          if ([string]::IsNullOrEmpty("${{ secrets.TAILSCALE_AUTH_KEY }}")) {
            $errors += "TAILSCALE_AUTH_KEY wajib diisi"
          }
          
          if ($errors.Count -gt 0) {
            Write-Host "âŒ ERROR: $($errors -join ', ')" -ForegroundColor Red
            exit 1
          }
          Write-Host "âœ… Semua secret OK" -ForegroundColor Green

      - name: âš¡ SET 1080p RESOLUTION
        run: |
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxXResolution" -Value 1920 -Force
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxYResolution" -Value 1080 -Force
          Write-Host "âœ… Resolusi 1080p dipaksa" -ForegroundColor Green

      - name: ğŸ‘¤ CREATE USER
        run: |
          $password = "${{ secrets.XY_RDP_PASSWORD }}"
          if ([string]::IsNullOrEmpty($password)) { $password = "Admin1080p@123" }
          
          # Hapus user lama
          $existing = Get-LocalUser -Name "h4ck3r" -ErrorAction SilentlyContinue
          if ($existing) { Remove-LocalUser -Name "h4ck3r" -Force }
          
          # Buat user baru
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "h4ck3r" -Password $securePass -FullName "Hacker 1080p" -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "h4ck3r"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "h4ck3r"
          
          # Simpan credential
          @{user="h4ck3r"; pass=$password} | ConvertTo-Json | Out-File "C:\cred.txt"
          Write-Host "âœ… User h4ck3r dibuat" -ForegroundColor Green

      - name: ğŸ› ï¸ INSTALL HACK TOOLS
        run: |
          # Install Chocolatey
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = 3072
          Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          
          # Install tools satu per satu (biar gak error sekaligus)
          $tools = @("nmap", "wireshark", "putty", "john-the-ripper", "hashcat")
          foreach ($tool in $tools) {
            try { choco install $tool -y --limit-output --no-progress } catch { Write-Host "âš ï¸ $tool gagal" }
          }
          Write-Host "âœ… Tools terinstall" -ForegroundColor Green

      - name: ğŸ”Œ TAILSCALE SETUP
        run: |
          # Download & install Tailscale
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $out = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $out
          Start-Process msiexec.exe -ArgumentList "/i", "`"$out`"", "/quiet", "/norestart" -Wait
          
          # Connect
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="hack-1080p"
          Start-Sleep -Seconds 5
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "âœ… Tailscale IP: $ip" -ForegroundColor Green

      - name: ğŸ“Š INFO
        run: |
          $publicIp = (Invoke-WebRequest -Uri "https://api.ipify.org" -UseBasicParsing).Content
          $cred = Get-Content "C:\cred.txt" | ConvertFrom-Json
          
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘      1080p HACKING SERVER         â•‘" -ForegroundColor Cyan
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
          Write-Host "â•‘ Public IP  : $publicIp" -ForegroundColor White
          Write-Host "â•‘ Tailscale  : $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "â•‘ Username   : $($cred.user)" -ForegroundColor Yellow
          Write-Host "â•‘ Password   : $($cred.pass)" -ForegroundColor Yellow
          Write-Host "â•‘ Resolution : 1920x1080" -ForegroundColor Magenta
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          # Simpan buat notif
          @{ip=$publicIp; ts=$env:TAILSCALE_IP; user=$cred.user; pass=$cred.pass} | ConvertTo-Json | Out-File "C:\info.json"

      - name: ğŸ“± SEND NOTIF
        run: |
          $info = Get-Content "C:\info.json" | ConvertFrom-Json
          $msg = "ğŸ”¥ 1080p HACK SERVER AKTIF!`nIP: $($info.ip)`nTailscale: $($info.ts)`nUser: $($info.user)`nPass: $($info.pass)"
          
          $webhook = "${{ secrets.DISCORD_WEBHOOK }}"
          if ($webhook) {
            $body = @{content=$msg} | ConvertTo-Json
            Invoke-RestMethod -Uri $webhook -Method Post -Body $body -ContentType "application/json"
          }

      - name: â™¾ï¸ KEEP ALIVE 7 DAYS
        run: |
          $end = (Get-Date).AddDays(7)
          while ((Get-Date) -lt $end) {
            $remaining = $end - (Get-Date)
            Write-Host "[$(Get-Date)] âœ… Server hidup - Sisa: $($remaining.Days) hari $($remaining.Hours) jam" -ForegroundColor Green
            Start-Sleep -Seconds 300
          }
