name: XY_RDP_1080P_FINAL

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'

jobs:
  XY_PROJECT:
    runs-on: windows-latest
    timeout-minutes: 360 

    steps:
      - name: üì• CHECKOUT XY_PROJECT
        uses: actions/checkout@v4

      - name: ‚úÖ VALIDASI SECRETS
        shell: powershell
        run: |
          if ([string]::IsNullOrEmpty("${{ secrets.TAILSCALE_AUTH_KEY }}")) {
            Write-Host "‚ùå ERROR: TAILSCALE_AUTH_KEY belum diisi di Secrets!" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Secrets OK" -ForegroundColor Green

      - name: üë§ SETUP USER XY (1080p)
        shell: powershell
        run: |
          $password = "${{ secrets.XY_RDP_PASSWORD }}"
          if ([string]::IsNullOrEmpty($password)) { $password = "XYAdmin1080p!" }
          
          # Buat User baru dengan brand XY
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "h4ck3r" -Password $securePass -FullName "XY Hacker" -Description "PoweredBy Kall & XyTeam"
          Add-LocalGroupMember -Group "Administrators" -Member "h4ck3r"
          
          # Aktifkan Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # Paksa Resolusi 1080p di Registry
          $rdpPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp"
          Set-ItemProperty -Path $rdpPath -Name "MaxXResolution" -Value 1920
          Set-ItemProperty -Path $rdpPath -Name "MaxYResolution" -Value 1080
          
          Write-Host "‚úÖ User h4ck3r & RDP 1080p Ready" -ForegroundColor Green

      - name: üîå TAILSCALE SETUP
        shell: powershell
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $out = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $out
          Start-Process msiexec.exe -ArgumentList "/i", "$out", "/quiet", "/norestart" -Wait
          
          $tsExe = "C:\Program Files\Tailscale\tailscale.exe"
          & $tsExe up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="XY-RDP-1080P"
          
          $ip = & $tsExe ip -4
          echo "TS_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "‚úÖ Tailscale IP: $ip" -ForegroundColor Green

      - name: üõ†Ô∏è INSTALL LIGHTSHOT
        shell: powershell
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12
          
          # Install Chocolatey jika belum ada
          if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }
          
          # Hanya install Lightshot (Chrome sudah ada di runner)
          choco install lightshot -y --no-progress
          Write-Host "‚úÖ Lightshot Berhasil Terpasang" -ForegroundColor Green

      - name: üì± SEND NOTIF XY
        shell: powershell
        run: |
          $publicIp = (Invoke-WebRequest -Uri "https://api.ipify.org" -UseBasicParsing).Content
          $msg = "‚ú® **XY_RDP ONLINE (1080p)** ‚ú®`n`nüìç IP: $publicIp`nüîå Tailscale: ${{ env.TS_IP }}`nüë§ User: h4ck3r`nüõ†Ô∏è Tools: Chrome & Lightshot Ready`n`nPoweredBy Kall & XyTeam"
          
          if ("${{ secrets.DISCORD_WEBHOOK }}") {
            $body = @{ content = $msg } | ConvertTo-Json
            Invoke-RestMethod -Uri "${{ secrets.DISCORD_WEBHOOK }}" -Method Post -Body $body -ContentType "application/json"
          }

      - name: ‚ôæÔ∏è KEEP ALIVE XY
        shell: powershell
        run: |
          $start = Get-Date
          # Berjalan maksimal 350 menit (kurang sedikit dari 6 jam limit GitHub)
          while ((Get-Date) -lt $start.AddMinutes(350)) {
            $remaining = [math]::Round((350 - ((Get-Date) - $start).TotalMinutes))
            Write-Host "üå∏ [$(Get-Date)] XY-RDP Aktif - Sisa: $remaining Menit" -ForegroundColor Cyan
            Start-Sleep -Seconds 120
          }
